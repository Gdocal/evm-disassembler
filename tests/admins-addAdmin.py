from z3 import *
from byte2op import Opcode, decode
from dasm import *

hexcode = '608060405234801561001057600080fd5b506004361061004c5760003560e01c806324d7806c1461005157806370480275146100985780638bad0c0a146100cd578063c4d66de8146100d5575b600080fd5b6100846004803603602081101561006757600080fd5b503573ffffffffffffffffffffffffffffffffffffffff16610108565b604080519115158252519081900360200190f35b6100cb600480360360208110156100ae57600080fd5b503573ffffffffffffffffffffffffffffffffffffffff1661011b565b005b6100cb610185565b6100cb600480360360208110156100eb57600080fd5b503573ffffffffffffffffffffffffffffffffffffffff16610223565b6000610115600183610341565b92915050565b61012433610108565b610179576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602a8152602001806105ac602a913960400191505060405180910390fd5b610182816103dc565b50565b61018e33610108565b6101e3576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602a8152602001806105ac602a913960400191505060405180910390fd5b6101ee600133610433565b6040805133815290517fa3b62bc36326052d97ea62d63c3d60308ed4c3ea8ac079dd8499f1e9c4f80c0f9181900360200190a1565b600054610100900460ff168061023c575061023c6104df565b8061024a575060005460ff16155b61029f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602e8152602001806105d6602e913960400191505060405180910390fd5b600054610100900460ff1615801561030557600080547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff007fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00ff909116610100171660011790555b61030e826103dc565b801561033d57600080547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00ff1690555b5050565b600073ffffffffffffffffffffffffffffffffffffffff82166103af576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260228152602001806106256022913960400191505060405180910390fd5b5073ffffffffffffffffffffffffffffffffffffffff166000908152602091909152604090205460ff1690565b6103e76001826104e5565b6040805173ffffffffffffffffffffffffffffffffffffffff8316815290517f44d6d25963f097ad14f29f06854a01f575648a1ef82f30e562ccd3889717e3399181900360200190a150565b61043d8282610341565b610492576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260218152602001806106046021913960400191505060405180910390fd5b73ffffffffffffffffffffffffffffffffffffffff1660009081526020919091526040902080547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00169055565b303b1590565b6104ef8282610341565b1561055b57604080517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601f60248201527f526f6c65733a206163636f756e7420616c72656164792068617320726f6c6500604482015290519081900360640190fd5b73ffffffffffffffffffffffffffffffffffffffff1660009081526020919091526040902080547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0016600117905556fe41646d696e733a2063616c6c657220646f6573206e6f74206861766520616e2061646d696e20726f6c65496e697469616c697a61626c653a20636f6e747261637420697320616c726561647920696e697469616c697a6564526f6c65733a206163636f756e7420646f6573206e6f74206861766520726f6c65526f6c65733a206163636f756e7420697320746865207a65726f2061646472657373a264697066735822122022c66779a46dbc0d3b6ee221b7e4da55bf1e3aa152efb3a21f809cadd5fdeb7e64736f6c63430007050033'

(ops, code) = decode(hexcode)

sol = Solver()

storage = Array('storage', BitVecSort(256), BitVecSort(256))

funsig = 0x70480275 # addAdmin(address)
#size = 2

sha3_256 = Function('sha3_256', BitVecSort(256), BitVecSort(256))

# calldata
sol.add(Extract(255, 224, f_calldataload(con(0))) == funsig) 

# sha3 is not too small nor too big
#sol.add(UGT(sha3_256(con(0)), con(100)))
#sol.add(ULT(sha3_256(con(0)), con(1000)))

# original data size
#sol.add(Select(storage, con(0)) == con(4))

exs = dasm(ops, code, sol, storage)
for ex in exs:
    print(ex)
